# Apple TV 自动播放下一个视频功能实现说明

## 功能概述

为 BiliBili tvOS 客户端实现了自动播放下一个相似视频的功能。当视频播放结束时,会自动获取相似视频并在倒计时后播放,提升用户观看体验。

## 实现的功能

### 1. 核心功能
- **自动推荐相似视频**: 视频结束时通过 B 站 API 获取相似视频
- **倒计时提示界面**: 显示下一个视频信息,默认 8 秒倒计时
- **用户交互控制**: 提供"立即播放"和"取消"按钮
- **设置开关**: 可在设置中启用/禁用自动播放功能

### 2. tvOS 特性优化
- **Focus Engine 支持**: 完整支持 tvOS 焦点导航系统
- **10 英尺 UI 设计**: 按钮和文字大小适配远距离观看
- **流畅动画效果**: tvOS 原生焦点动画和过渡效果
- **Remote 遥控器交互**: 优化了 Apple TV 遥控器操作体验

## 技术实现

### 文件结构

#### 新增文件
1. **AutoPlayPromptPlugin.swift** (`BilibiliLive/Component/Player/Plugins/`)
   - 自动播放提示插件
   - UI 界面实现
   - 倒计时逻辑
   - tvOS Focus Engine 集成

#### 修改文件
1. **NewVideoPlayerViewModel.swift**
   - 集成自动播放逻辑
   - 添加相似视频获取方法
   - 处理播放结束事件

2. **WebRequest.swift**
   - 添加 async 版本的 `requestRelatedVideo` API

3. **Settings.swift** (通过 Extension)
   - 添加 `autoPlayEnabled` 设置项
   - 添加 `autoPlayCountdownDuration` 倒计时时长设置

### 核心组件

#### AutoPlayPromptPlugin
```swift
class AutoPlayPromptPlugin: NSObject, CommonPlayerPlugin {
    // 主要功能:
    // 1. 显示自动播放提示 UI
    // 2. 倒计时管理
    // 3. 用户交互处理
    // 4. tvOS Focus Engine 支持
}
```

**主要方法**:
- `showAutoPlayPrompt(for:title:)`: 显示自动播放提示
- `hideAutoPlayPrompt()`: 隐藏提示界面
- `addMenuItems()`: 添加设置菜单项

#### VideoPlayerViewModel 扩展

```swift
extension VideoPlayerViewModel {
    // 处理视频播放结束
    private func handleVideoEnd()

    // 获取下一个自动播放视频
    private func fetchNextAutoPlayVideo(for:) -> PlayInfo?
}
```

**工作流程**:
1. 视频播放结束触发 `handleVideoEnd()`
2. 通过 B 站 API 获取相似视频列表
3. 过滤出第一个不同于当前视频的推荐
4. 获取视频详情并显示提示界面
5. 倒计时结束或用户点击"立即播放"后开始播放

### API 集成

#### 相似视频推荐 API
```swift
static func requestRelatedVideo(aid: Int) async throws -> [VideoDetail.Info]
```

使用 B 站的相关视频推荐接口:
- Endpoint: `https://api.bilibili.com/x/web-interface/archive/related`
- 参数: `aid` (当前视频的 av 号)
- 返回: 相似视频信息列表

### Settings 配置

新增两个用户设置:
1. **autoPlayEnabled** (Bool, 默认: true)
   - 控制是否启用自动播放功能

2. **autoPlayCountdownDuration** (Int, 默认: 8)
   - 自动播放倒计时秒数

## UI 设计

### 自动播放提示界面

```
┌─────────────────────────────────────────┐
│                                         │
│       即将播放下一个视频                │
│                                         │
│      [视频标题]                         │
│                                         │
│            8秒                          │
│                                         │
│   [立即播放]     [取消]                 │
│                                         │
└─────────────────────────────────────────┘
```

**样式特点**:
- 居中显示的半透明黑色背景
- 圆角边框 (16pt radius)
- 大字体适配 10 英尺观看距离
- tvOS 原生按钮样式和焦点效果

### Focus Engine 优化

- 默认焦点设置在"立即播放"按钮
- 支持遥控器方向键导航
- 焦点动画效果流畅自然
- 按钮点击响应 `.primaryActionTriggered` 事件

## 使用说明

### 用户体验流程

1. **正常播放**: 用户观看视频
2. **播放结束**: 视频播放完毕
3. **自动推荐**: 系统自动获取相似视频
4. **倒计时提示**: 显示下一个视频信息和倒计时
5. **用户选择**:
   - 等待倒计时结束 → 自动播放下一个视频
   - 点击"立即播放" → 立即开始播放
   - 点击"取消" → 退出播放器

### 设置控制

在视频播放器菜单中:
1. 点击遥控器菜单按钮
2. 选择"自动播放下一个"选项
3. 切换开关状态
4. 设置立即生效

## 兼容性

### 系统要求
- **平台**: tvOS 16.0+
- **设备**: Apple TV 4K / Apple TV HD
- **遥控器**: Siri Remote / Apple TV Remote

### 现有功能兼容
- ✅ 与播放列表插件协同工作
- ✅ 支持循环播放模式
- ✅ 兼容弹幕、倍速等其他插件
- ✅ 不影响 DLNA 投屏功能
- ✅ 支持画质自适应

## 测试建议

### 功能测试
1. **基本流程测试**
   - 播放视频至结束
   - 验证自动播放提示显示
   - 测试倒计时功能
   - 确认自动播放生效

2. **用户交互测试**
   - 测试"立即播放"按钮
   - 测试"取消"按钮
   - 验证 Focus 导航
   - 测试设置开关

3. **边界情况测试**
   - 无相似视频时的处理
   - API 请求失败的降级策略
   - 快速连续播放多个视频
   - 网络异常情况

### UI/UX 测试
1. **10 英尺界面测试**
   - 在真实 Apple TV 设备上测试
   - 验证文字大小和可读性
   - 检查按钮大小和点击区域
   - 确认颜色对比度

2. **Focus Engine 测试**
   - 验证初始焦点位置
   - 测试焦点切换流畅性
   - 确认焦点视觉反馈
   - 测试遥控器响应

### 性能测试
- 内存使用检测
- API 响应时间
- UI 渲染性能
- 长时间使用稳定性

## 后续优化建议

### 功能增强
1. **智能推荐算法**
   - 基于用户历史观看记录
   - 考虑用户喜好和标签
   - 个性化推荐权重调整

2. **用户体验优化**
   - 可自定义倒计时时长
   - 显示视频封面图
   - 添加视频简介预览
   - 支持手势快速操作

3. **数据统计**
   - 记录自动播放使用率
   - 分析用户取消原因
   - 优化推荐准确度

### 技术优化
1. **性能优化**
   - 预加载下一个视频信息
   - 缓存相似视频列表
   - 优化 API 请求策略

2. **容错处理**
   - 更完善的错误处理
   - 重试机制优化
   - 用户友好的错误提示

## 开发者注意事项

### 代码规范
- 所有代码已通过 SwiftFormat 格式化
- 遵循项目现有代码风格
- 使用 Swift 5+ 特性
- 支持异步/并发模式

### 插件系统集成
- 遵循 `CommonPlayerPlugin` 协议
- 与其他插件协同工作
- 正确处理生命周期方法
- 避免资源泄露

### tvOS 开发最佳实践
- 使用 UIKit for tvOS
- 遵循 Focus Engine 规范
- 支持 Safe Area 布局
- 优化远距离观看体验

## 总结

本次实现完整地为 Apple TV Bilibili 客户端添加了自动播放下一个相似视频的功能,包括:

✅ 核心自动播放逻辑
✅ tvOS 原生 UI 界面
✅ Focus Engine 完整支持
✅ 用户设置控制
✅ API 集成和错误处理
✅ 代码格式化和规范

该功能与现有播放器架构完美集成,充分考虑了 tvOS 平台特性,提供了流畅的用户体验。
